version: 2.1
jobs:
  minsar-testing:
    machine:
      image: default

    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
              - "SHA256:UQXk8EzF60pAQ4fbeZgkWDcI3OMEXV5LcyuK6KJzJy8"
      - run:
          name: Set up Environment
          command: |
            echo "Working directory: ${PWD}"
            ./setup/install_python.bash
            ./setup/install_minsar.bash
            minsar/bin/minsarApp.bash --help
            echo "alias s.bw2='export MINSAR_HOME=${CIRCLE_WORKING_DIRECTORY}; source project/setup/environment.bash'" >> ~/.bashrc

      - run:
          name: Run Unit Tests
          command: |
            set +u   # needed for circleCI
            source tools/miniforge3/etc/profile.d/conda.sh
            conda activate minsar
            
            export MINSAR_HOME=${CIRCLE_WORKING_DIRECTORY}
            source setup/environment.bash
            
            # Run the unified test suite
            ./run_all_tests.bash

      - run:
          name: Prepare test data (Sentinel-1)
          command: |
            set +u   # needed for circleCI
            source tools/miniforge3/etc/profile.d/conda.sh
            conda activate minsar
            
            export MINSAR_HOME=${CIRCLE_WORKING_DIRECTORY}
            source setup/environment.bash    

            wget -O- http://149.165.154.65/data/circleci/ci_small_unittestGalapagosSenDT128.tar | tar -xvf - -C ${SCRATCHDIR}
            wget -O- http://149.165.154.65/data/circleci/S1orbits_unittestGalapagosSenDT128.tar | tar -xvf - -C "$(dirname ${SENTINEL_ORBITS})"
            
            minsarApp.bash ${MINSAR_HOME}/samples/circleci/ci_unittestGalapagosSenDT128.template --no-orbit-download --start dem --stop jobfiles
            
workflows:
  version: 2
  testing:
    jobs:
      - minsar-testing
